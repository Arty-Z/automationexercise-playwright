# This is the name that shows up in GitHub Actions tab
name: Scheduled E2E Tests for Production

# When should this workflow run?
on:
  # Run automatically on a schedule (like an alarm clock!)
  schedule:
    # Runs every day at 2 AM CST (which is 8 AM UTC time)
    # The 5 numbers mean: minute hour day month day-of-week
    # '0 8 * * *' = at 8:00 AM UTC, every day, every month, every day of the week
    - cron: '0 8 * * *'
  # Also allow running manually by clicking a button in GitHub
  workflow_dispatch:

# The actual work that needs to be done
jobs:
  # This job is called "test" - you can name it anything you want
  test:
    # Use a computer running Ubuntu Linux (GitHub provides this for free!)
    runs-on: ubuntu-latest
    timeout-minutes: 60  # Prevent the job from running forever
    
    # Give this workflow permission to write to the repository
    permissions:
      contents: write  # Allows pushing to gh-pages branch
      pages: write     # Allows deploying to GitHub Pages
      id-token: write  # Required for Pages deployment
    
    # The steps are like a recipe - do them in order, one by one
    steps:
      # Step 1: Get a copy of your code from GitHub
      - name: Checkout code
        uses: actions/checkout@v4

      # Step 2: Install Node.js (like installing an app on your phone)
      # Node.js is needed to run your Playwright tests
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'  # Use the latest stable LTS version of Node.js
          cache: 'npm'            # Save npm packages so next time is faster

      # Step 3: Install all the packages your project needs
      # (like installing all the toys before you can play)
      - name: Install dependencies
        run: npm ci

      # Step 4: Install Playwright browsers
      # Playwright needs real browsers to test your website
      - name: Install Playwright Browsers
        run: npx playwright install --with-deps chromium firefox webkit
        env:
          PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: 0
        timeout-minutes: 10

      # Step 5: Actually run your E2E tests!
      - name: Run Playwright tests
        env:
          # These are settings your tests might need
          # Using secrets from repository secrets (matching .env file)
          BASE_URL: ${{ secrets.BASE_URL || 'https://automationexercise.com' }}
          USERNAME: ${{ secrets.USERNAME }}
          PASSWORD: ${{ secrets.PASSWORD }}
        run: npx playwright test  # This runs all your Playwright tests

      # Step 6: Save the test results (even if tests failed!)
      # 'if: always()' means "do this step no matter what happened before"
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-prod      # Name for this bundle of files
          path: |
            test-results/
            playwright-report/
          retention-days: 30           # Keep these files for 30 days
          if-no-files-found: warn      # Warn if no files found

      # Step 7: Save the pretty HTML report (even if tests failed!)
      - name: Upload HTML report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-prod # Name for this bundle of files
          path: playwright-report/     # Which folder to save
          retention-days: 30           # Keep these files for 30 days
          if-no-files-found: warn      # Warn if no report folder exists

      # Step 8: Put the report on a website so anyone can see it!
      # This publishes to GitHub Pages (like putting your artwork on the fridge)
      - name: Publish test report to GitHub Pages
        if: always()
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}  # Password to publish (GitHub gives you this automatically)
          publish_dir: ./playwright-report            # The folder with your report
          destination_dir: test-reports/prod/${{ github.run_number }}  # Where to put it (each run gets its own number)
          keep_files: true                            # Don't delete old reports

      # Step 9: Print a message with the link to the report
      # Only do this if someone ran the tests manually (not on the schedule)
      - name: Comment with report link
        if: always() && github.event_name == 'workflow_dispatch'
        run: |
          echo "Production Test report available at: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/test-reports/prod/${{ github.run_number }}"